<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/i/378 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <!-- Our site title and description -->
    <title>Creating a DocPad plugin | Jose quesada: E-commerce database marketing</title>
    <meta name="description" content="Website of Jose Quesada." />
    <meta name="keywords" content="quesada, jose quesada, R, semantic web, semantic analysis, predictive models, statistics, machine learning, marketing, psychographics, cognitive science, database marketing" />
    <meta name="author" content="Jose Quesada" />

    <!-- Output DocPad produced meta elements -->
    <meta http-equiv="X-Powered-By" content="DocPad"/>

    <!-- Mobile viewport optimized: h5bp.com/viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- DocPad Meta Information -->
    <meta http-equiv="X-Powered-By" content="DocPad"/>


    <!-- Shims: IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
        <script async src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" href="/styles/skeleton.css" />
    <link rel="stylesheet" href="/styles/base.css" />
    <link rel="stylesheet" href="/styles/layout.css" />
    <link rel="stylesheet" href="/styles/font-awesome.css" />
    <link rel="stylesheet" href="/styles/github.css" />

    <!-- convertable contact forms with analytics -->
    <script type="text/javascript">
    var trackerID = "3a39856ed90784117b180fecb5102e79"; // account identifier
    document.write("<script type=\"text/JavaScript\" src=\"http://convertable.com/admin/script.js\"></"+"script>");
    </script>

    <!-- google analytics -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', "UA-36430477-1"]);
      _gaq.push(['_setDomainName', 'josequesada.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>

    <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src=("https:"===e.location.protocol?"https:":"http:")+'//cdn.mxpnl.com/libs/mixpanel-2.2.min.js';f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f);b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==
        typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.increment people.append people.track_charge".split(" ");for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2}})(document,window.mixpanel||[]);
        mixpanel.init("3fcbcafa555fc23a2d9863437ee2af0d");</script><!-- end Mixpanel -->
</head>

<body>

    <div class="wrap-header">
        <div class="container">
            <h1 class="logo"><a href="/" title="Jose Quesada PhD Ecommerce database marketing">Jose Quesada</a></h1>
            <nav class="primary">
                <ul>
                    <li><a href="/problems-and-solutions.html">problems & solutions</a> / </li>
                    <!-- <li><a href="/why-you-should-work-with-me.html">problems & solutions</a> / </li> -->
                    <li><a href="/blog.html">blog</a> / </li>
                    <li><script type="text/javascript" language="javascript">
                    <!--
                    // Email obfuscator script 2.1 by Tim Williams, University of Arizona
                    // Random encryption key feature by Andrew Moulden, Site Engineering Ltd
                    // This code is freeware provided these four comment lines remain intact
                    // A wizard to generate this code is at http://www.jottings.com/obfuscator/
                    { coded = "Ga@EOmac4amWvW.7OG"
                      key = "01yc9R8u3rmDNFLvWo5AC7YgV4nfG6zMjwkOxHJUileBZQTqbKE2IpsPShtdaX"
                      shift=coded.length
                      link=""
                      for (i=0; i<coded.length; i++) {
                        if (key.indexOf(coded.charAt(i))==-1) {
                          ltr = coded.charAt(i)
                          link += (ltr)
                        }
                        else {
                          ltr = (key.indexOf(coded.charAt(i))-shift+key.length) % key.length
                          link += (key.charAt(ltr))
                        }
                      }
                    document.write("<a href='mailto:"+link+"'>contact</a>")
                    }
                    //-->
                    </script><noscript>Sorry, you need Javascript on to email me.</noscript>
                    </li>
                </ul>
            </nav>
        </div>
    </div>


<!-- end header and top nav bar -->


    <div class="container post">
    <div class="two-thirds">
        <article id="post" class="post">
            <h1>Creating a DocPad plugin</h1>
            <div class="post-date">Sunday, December 02, 2012</div>
            <div class="post-content"><p>In order to complete the switch to DocPad I wanted my blog to support a paged index of my blog posts. I didn&#39;t want to display them all in one big long page, but split them up into groups of 3 or 5 with &#39;Older&#39; and &#39;Newer&#39; links to let users navigate the posts. Sadly this functionality isn&#39;t available by default in DocPad, but never fear DocPad is built with a plugin framework so we can add this functionality ourselves.</p>

<p>In the next couple of posts I&#39;m going to walk through the creation of the <a href="http://github.com/benjamind/docpad-plugin-paged">Paged Plugin</a> which I recently put together for just this purpose.</p>

<h3>A basic plugin</h3>

<p>The docpad site has a <a href="http://bevry.me/docpad/plugin-write">getting started guide</a> for how to setup a basic plugin thats a part of your site. Simply create the following folder and file structure where <code>yourPlugin</code> is the name of your plugin:</p>

<pre class="highlighted"><code class="bash">my-site/
        src
        ...
        plugins/
                  yourPlugin/
                               yourPlugin.plugin.coffee
                               package.json
        ...
        docpad.coffee
        README.md
        package.json
</code></pre>

<p>The <code>package.json</code> is required and needs to use the format specified on the <a href="http://bevry.me/docpad/plugin-write">docpad website</a>.</p>

<p>Much to my dislike the standard way of writing plugins for DocPad is with CoffeeScript, you could do it with straight JavaScript but you won&#39;t get as much help from the documentation. I&#39;ll look into writing a straight JavaScript plugin guide sometime in the future, for now lets just use CoffeeScript.</p>

<h3>Pagination</h3>

<p>For my paging implementation I wanted to be able to create a document in DocPad that was &#39;pageable&#39;, either looping over a collection of documents to render out sub-pages like on a blog index page, or looping a set number of times so that we can genereate pages on the fly or split up a long document across multiple pages. I tried out various ideas, and read <a href="https://github.com/bevry/docpad/issues/116">this issue</a> which details some possible solutions for paging. In the end I settled on the following approach:</p>

<ul>
<li>Set the <code>isPaged</code> property to true on pageable documents</li>
<li>Specify a <code>pageCount</code> property if you want a fixed number of pages <strong>or</strong></li>
<li>Specify a <code>pagedCollection</code> property which specifies the name of a collection over which you want paging to be applied.</li>
<li>Specify a <code>pageSize</code> property to set how many documents are looped over in each page.</li>
</ul>

<p>The plugin will function as follows:</p>

<ul>
<li>Before we render the documents

<ul>
<li>Loop over the documents</li>
<li>Find those that have the <code>isPaged</code> property

<ul>
<li>Read the <code>pageCount</code> or <code>pagedCollection</code> property to determine number of pages</li>
<li>Read the <code>pageSize</code> property to determine document indexes in each page</li>
<li>For every page we need to create:

<ul>
<li>Clone the document and add it to a new collection</li>
<li>Add a <code>page</code> object to the cloned document detailing current page details</li>
<li>Add a <code>firstPageDoc</code> object to the cloned document which points back to the original document</li>
</ul></li>
</ul></li>
<li>For every document in the new collection:

<ul>
<li>Normalize and contextualize the new document</li>
<li>Modify the <code>outFilename</code> and <code>basename</code> of the new document to reflect its page number</li>
</ul></li>
<li>Render the document collection</li>
</ul></li>
</ul>

<h3>To the code!</h3>

<p>So lets get started. Here&#39;s the basic plugin code that we&#39;re going to start with:</p>

<pre class="highlighted"><code class="php"> <span class="comment"># Export Plugin</span>
module.exports = (BasePlugin) -&gt;
    <span class="comment"># balUtil required for queing up tasks</span>
    balUtil = <span class="keyword">require</span>(<span class="string">'bal-util'</span>)

    <span class="comment"># Define Plugin</span>
    <span class="class"><span class="keyword">class</span> <span class="title">PagedPlugin</span> <span class="keyword">extends</span> <span class="title">BasePlugin</span>
        <span class="title">name</span>: '<span class="title">paged</span>'

        <span class="title">renderBefore</span>: (<span class="title">opts</span>,<span class="title">next</span>) -&gt;
            <span class="title">docpad</span> = @<span class="title">docpad</span>

            {</span>collection,templateData} = opts

            pagesToRender = <span class="keyword">new</span> docpad.FilesCollection()
...
</code></pre>

<p>This setups my basic plugin, it extends from <code>BasePlugin</code> and hooks into the <code>renderBefore</code> event, a full listing of all events in docpad is <a href="http://bevry.me/docpad/events">available here</a>. The <code>renderBefore</code> event receives two values in its <code>opts</code> argument, the <code>collection</code> and the <code>templateData</code>. The <code>collection</code> is the collection of documents that we are rendering, and the <code>templateData</code> is the data object that is passed to the documents when rendering. Note we also <code>require</code> the <a href="https://github.com/balupton/bal-util"><code>bal-util</code></a> module which we&#39;ll use later on.</p>

<p>Now we need to loop over our documents and figure out how / if they need paging:</p>

<pre class="highlighted"><code class="vbscript">...
            collection.forEach (document) -&gt;
                meta = document.getMeta()

                <span class="keyword">if</span> (!meta.<span class="keyword">get</span>(<span class="comment">'isPaged'))</span>
                    return

                # <span class="keyword">let</span> the page meta specify count <span class="keyword">or</span> use <span class="number">1</span> by <span class="keyword">default</span>
                numberOfPages = meta.<span class="keyword">get</span>(<span class="comment">'pageCount') or 1</span>
                pageSize = meta.<span class="keyword">get</span>(<span class="comment">'pageSize') or 5</span>
                lastDoc = pageSize * numberOfPages

                # <span class="keyword">if</span> pagedCollection <span class="keyword">is</span> specified <span class="keyword">then</span> use that <span class="keyword">to</span> determine number of pages
                <span class="keyword">if</span> meta.<span class="keyword">get</span>(<span class="comment">'pagedCollection')</span>
                    pagedCollectionName = meta.<span class="keyword">get</span>(<span class="comment">'pagedCollection')</span>
                    pagedCollection = docpad.getCollection(pagedCollectionName)
                    numberOfPages = Math.ceil(pagedCollection.length / pageSize)
                    lastDoc = pagedCollection.length

                # create a page object <span class="keyword">for</span> this page
                document.<span class="keyword">set</span>(page: {
                    count: numberOfPages,
                    number: <span class="number">0</span>,
                    size: pageSize,
                    startIdx: <span class="number">0</span>,
                    endIdx: Math.min(pageSize,lastDoc)
                })

                document.<span class="keyword">set</span>(firstPageDoc: document)

                # <span class="keyword">loop</span> over the number of pages we have <span class="keyword">and</span> generate a clone of this document <span class="keyword">for</span> <span class="keyword">each</span>
                <span class="keyword">if</span> numberOfPages &gt; <span class="number">1</span>
                    <span class="keyword">for</span> n <span class="keyword">in</span> [<span class="number">1.</span>.numberOfPages-<span class="number">1</span>]
                        pagedDocData = document.toJSON()

                        pagedDoc = docpad.createDocument(pagedDocData)
                        pagedDoc.<span class="keyword">set</span>(page: {
                            count: numberOfPages,
                            number: n,
                            size: pageSize,
                            startIdx: n*pageSize,
                            endIdx: Math.min((n*pageSize) + pageSize,lastDoc)
                        })
                        pagedDoc.<span class="keyword">set</span>(firstPageDoc: document)
                        pagesToRender.add(pagedDoc)
...
</code></pre>

<p>So for each document in the collection we retrieve the meta object and test to see if the <code>isPaged</code> property is true. If it is we retrieve the <code>pageCount</code>, <code>pageSize</code> and optionally the <code>pagedCollection</code> properties. We use this information to figure out the number of pages we&#39;re going to render, and the start and end indexes of the documents in each page. If we&#39;ve got more than one page then for each page we copy the current document, add a page object to the document and then add it to our collection of pages to render.</p>

<p>Almost there, now we just need to make these documents complete and contextual so they can be rendered:</p>

<pre class="highlighted"><code class="matlab">...
            tasks = new <span class="transposed_variable">balUtil.</span>Group(next)

            <span class="transposed_variable">pagesToRender.</span>forEach (document) -&gt;

                <span class="transposed_variable">tasks.</span>push (complete) -&gt;
                    <span class="transposed_variable">document.</span>normalize(<span class="cell">{}</span>, complete)

                <span class="transposed_variable">tasks.</span>push (complete) -&gt;
                    <span class="transposed_variable">document.</span>contextualize(<span class="cell">{}</span>, complete)

                <span class="transposed_variable">tasks.</span>push (complete) -&gt;
                    page = <span class="transposed_variable">document.</span>get(<span class="string">'page'</span>)

                    basename = <span class="transposed_variable">document.</span>get(<span class="string">'basename'</span>)
                    outFilename = <span class="transposed_variable">document.</span>get(<span class="string">'outFilename'</span>)

                    outFilename = <span class="transposed_variable">outFilename.</span>replace(basename,basename+<span class="string">'.'</span> + <span class="transposed_variable">page.</span>number)
                    basename = basename + <span class="string">'.'</span> + <span class="transposed_variable">page.</span>number

                    <span class="transposed_variable">document.</span>set(<span class="string">'basename'</span>,basename)
                    <span class="transposed_variable">document.</span>set(<span class="string">'outFilename'</span>, outFilename)

                    complete()

            <span class="transposed_variable">tasks.</span>push (complete) -&gt;
                <span class="transposed_variable">docpad.</span>generateRender(<span class="cell">{collection: pagesToRender}</span>,complete)

            <span class="keyword">return</span> <span class="transposed_variable">tasks.</span>async()
</code></pre>

<p>Here we&#39;ve used the <a href="https://github.com/balupton/bal-util"><code>bal-util</code></a> module. This module has a few helpful little methods that make doing sequences of tasks a lot cleaner. Here we&#39;ve created a sequence of tasks that will be executed asyncronously and after all tasks are completed the <code>next</code> method callback will be executed. The list of tasks is created by looping over the <code>pagesToRender</code> and for each document first normalizing it then contextualizing it then modifying its output and base filenames. Finally the last task added to the queue is to render the pagesToRender collection.</p>

<p>Normalization is basically the task which goes through the document and ensures all the values are updated appropriately, for instance if you change one value it might update another value as a knock-on effect. Contextualize is similar in that it sets the document up in the context of the rest of the site, for instance it generates the url property. So its important that we call both these methods on any new documents before we render them otherwise things just don&#39;t work quite right. This is also why we do the modification of the <code>basename</code> and <code>outFilename</code> properties after calling these methods as otherwise they would be reset back to the original document values.</p>

<p>By calling <code>tasks.async()</code> we execute the queue of tasks and then pass execution onto <code>next</code> allowing docpad to continue. With this the plugin is working! In the full version of the plugin I&#39;ve gone ahead and added some helper functions to the <code>DocumentModel</code> that make it a bit cleaner to render pagination and operate over pages, if you want to take a look checkout the <a href="https://github.com/benjamind/docpad-plugin-paged">full source here</a>.</p>

<h3>Summary</h3>

<p>So we&#39;ve built a plugin that operates within our site to render out paged documents based off an original source document. I decided to share this plugin with everyone so I&#39;ve packaged it up as a <a href="https://npmjs.org/package/docpad-plugin-paged">package on NPM</a> if you want to use it in one of your own sites. In my next post I&#39;ll explain how I did that, and how to get Unit Testing working on DocPad plugins.</p>
</div>
        </article>
    </div>

    <!-- comments -->

</div>

<div class="container sidebar">
    <div class="one-third">
        
            <h3>Related Posts</h3>
            
                <li><a href="/posts/blogging-with-docpad.html">Blogging with DocPad</a></li>
            
                <li><a href="/posts/unit-testing-docpad-plugins.html">Unit Testing DocPad plugins</a></li>
            
                <li><a href="/posts/creating-the-index-page.html">Creating the index page</a></li>
            
                <li><a href="/posts/amazon.html">What do we learn from Amazon's success?</a></li>
            
                <li><a href="/posts/going-static.html">Going Static</a></li>
            
        

        <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'urlwolf'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


<!-- <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1; // this makes it work on localhost. Not for me though
    (function() {
        window.disqus_shortname = 'urlwolf';
        window.disqus_developer = document.location.href.indexOf('localhost') !== -1 ? 1 : 0;
        window.disqus_url = document.location.href
        window.disqus_identifier = 'posts-creating-a-docpad-plugin';
        window.disqus_title = 'Creating a DocPad plugin';
        if ( window.DISQUS) {
            return DISQUS.reset({
                reload: true,
                config: function () {
                    this.page.identifier = window.disqus_identifier;
                    this.page.url = window.disqus_url;
                    this.page.title = window.disqus_title;
                }
            });
        }
        else {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </div>
</div>


<!-- TODO: add CTA: follow me on twitter, subscribe to my newsletter, etc -->

<!-- TODO, get this into partials -->
<!-- start of footer -->
    <footer>
        <div class="container widgets">
            <div class="one-third column  about">
                <h2>About Me</h2>
                <img src="images/josequesada.jpg" alt="" class="thumb"/>
                <div>
                    <p>I'm a modeler, with a PhD in Machine learning. I worked at top labs (U. of Colorado, Boulder; Carnegie Mellon); But my specialty is to find and optimize business value. If you think you can decide better, do better, or be better through data, contact me for a free consultation: </p>

                    <script type="text/javascript" language="javascript">
                    <!--
                    // Email obfuscator script 2.1 by Tim Williams, University of Arizona
                    // Random encryption key feature by Andrew Moulden, Site Engineering Ltd
                    // This code is freeware provided these four comment lines remain intact
                    // A wizard to generate this code is at http://www.jottings.com/obfuscator/
                    { coded = "Ga@EOmac4amWvW.7OG"
                      key = "01yc9R8u3rmDNFLvWo5AC7YgV4nfG6zMjwkOxHJUileBZQTqbKE2IpsPShtdaX"
                      shift=coded.length
                      link=""
                      for (i=0; i<coded.length; i++) {
                        if (key.indexOf(coded.charAt(i))==-1) {
                          ltr = coded.charAt(i)
                          link += (ltr)
                        }
                        else {
                          ltr = (key.indexOf(coded.charAt(i))-shift+key.length) % key.length
                          link += (key.charAt(ltr))
                        }
                      }
                    document.write("<a href='mailto:"+link+"'>me@josequesada.com</a>")
                    }
                    //-->
                    </script><noscript>Sorry, you need Javascript on to email me.</noscript>
                    <br>



                    <ul>
                        <!-- <li><a href="#" target="_blank"><img src="images/facebook.png" alt="" /></a></li> -->
                        <li><a href="https://twitter.com/quesada" target="_blank"><img src="images/twitter.png" alt="" /></a></li>
                        <li><a href="de.linkedin.com/in/jfquesada/" target="_blank"><img src="images/linkedin.jpg" alt="" /></a></li>

                        <li><a href="atom.xml" target="_blank"><img src="images/rss.png" alt="" /></a></li>
                    </ul>
                </div>
            </div>

            <div class="one-third column  blog">
               <h2>Resources</h2>
                <nav>
                    <ul>
                        
                            <li class="">
                                <a href="/blog.html" property="dc:title">Blog</a>
                            </li>
                        
                    </ul>
                </nav>
            </div>

  <div class="one-third column  blog">
        <h2>Recent posts</h2>
            <nav>
                <ul>
                    
                    
                        
                        <li class="">
                            <a href="/posts/technical-reasons-not-to-pic-google-website-optimizer.html" property="dc:title">Technical reasons not to use google website optimizer (and Usability reasons too)</a>
                        </li>
                    
                        
                        <li class="">
                            <a href="/posts/unit-testing-docpad-plugins.html" property="dc:title">Unit Testing DocPad plugins</a>
                        </li>
                    
                        
                        <li class="active">
                            <a href="/posts/creating-a-docpad-plugin.html" property="dc:title">Creating a DocPad plugin</a>
                        </li>
                    
                        
                        <li class="">
                            <a href="/posts/amazon.html" property="dc:title">What do we learn from Amazon's success?</a>
                        </li>
                    
                        
                        <li class="">
                            <a href="/posts/creating-the-index-page.html" property="dc:title">Creating the index page</a>
                        </li>
                    
                        
                        <li class="">
                            <a href="/posts/blogging-with-docpad.html" property="dc:title">Blogging with DocPad</a>
                        </li>
                    
                        
                        <li class="">
                            <a href="/posts/going-static.html" property="dc:title">Going Static</a>
                        </li>
                    
                </ul>
            </nav>
                <a class="dark-more">view more</a>
            </div>
    </footer>

    <footer class="sub-footer">
            <div class="container">
                <div class="eight columns left">
                    <p>Copyright 2012 <a href="#">Made with love from Berlin</a> </p>
                </div>

                <div class="eight columns right">
                    <div class="mixpanel">
                        <a href="https://mixpanel.com/f/partner"><img src="http://cdn.mxpnl.com/site_media/images/partner/badge_blue.png" alt="Mobile Analytics" /></a>
                    </div>
                    <!-- <h1 class="logo"><a href="#" title="Jose Quesada">Jose Quesada</a></h1> -->
                </div>
            </div>
    </footer>
    <script  src="/socket.io/socket.io.js"></script><script >var socket = io.connect('/docpad-live-reload');
socket.on('regenerated',function(){
	document.location.reload();
});</script>
</body>
</html>